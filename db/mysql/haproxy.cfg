global
    log stdout format raw local0
    maxconn 4096

    # Runtime API 활성화 - 재시작 없이 설정 변경 가능
    stats socket /tmp/haproxy.sock mode 660 level admin expose-fd listeners
    stats timeout 30s

defaults
    log     global
    mode    tcp
    option  tcplog
    option  dontlognull
    timeout connect 5000
    timeout client  50000
    timeout server  50000

# Stats 페이지 - 실시간 연결 모니터링
frontend stats
    bind *:8404
    mode http
    stats enable
    stats uri /
    stats refresh 10s
    stats show-legends
    stats show-node
    # 기본 인증 (사용자명: admin, 비밀번호: admin123)
    # 보안을 위해 반드시 비밀번호를 변경하세요!
    stats auth admin:admin123
    stats admin if TRUE

frontend mysql_frontend
    bind *:3306
    mode tcp

    # Brute Force 방어 - Rate Limiting
    # 더 엄격: 5초 동안 3회 → 차단
    stick-table type ip size 100k expire 30s store conn_rate(5s)
    tcp-request connection track-sc0 src
    tcp-request connection reject if { sc_conn_rate(0) gt 3 }

    # 파일 기반 ACL - Runtime API로 실시간 수정 가능
    # allowed_ips.txt 파일에서 허용 IP 목록을 읽어옴
    acl allowed_ips src -f /etc/haproxy/allowed_ips.txt

    # 허용되지 않은 IP는 연결 거부
    tcp-request connection reject if !allowed_ips

    # 허용된 IP는 MySQL 백엔드로 전달
    default_backend mysql_backend

backend mysql_backend
    mode tcp
    balance roundrobin
    option tcp-check

    # MySQL 컨테이너로 연결 (docker-compose의 서비스명 사용)
    server mysql mysql:3306 check
